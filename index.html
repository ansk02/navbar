<?php

require 'db_config.php';
require 'function.php';

error_reporting(1);
session_start();

if (!empty($_POST)) {

    $error = array();
    $pattern = "/^[a-zA-Z0-9_]+$/";
    if (!isset($_POST['name']) && (empty($_POST['name']) || !preg_match($pattern, $_POST['name']))) {
        $error['username'] = "Le pseudo doit contenir des lettres des chiffres";
    } else {
        $user = $_POST['name'];
        $query = "SELECT id FROM users WHERE username = '$user'";
        $result = mysqli_query($connexion, $query);

        if (!$result) {
            printf("Error: %s\n", mysqli_error($connexion));
            exit();
        }

        $data = mysqli_fetch_array($result);

        if ($data) {
            $error['username'] = "Ce pseudo est déjà pris";
            // exit();
        }
    }

    if (empty($_POST['email']) && !filter_var($_POST['email'], FILTER_VALIDATE_EMAIL)) {
        $error['email'] = "Veuillez saisir un format d'email correct";
    } else {
        $email = $_POST['email'];

        $query = "SELECT  id FROM users WHERE email = '$email'";
        $result = mysqli_query($connexion, $query);

        if (!$result) {
            printf("Error: %s\n", mysqli_error($connexion));
            exit();
        }

        $data = mysqli_fetch_array($result);

        if ($data) {
            $error['email'] = "Cette adresse est deja utilisée pour un autre compte";
            // header('Location: index.php');
            // exit();
        }
    }

    $pwdpattern = "/^[0-9a-zA-Z_]$/";
    if (empty($_POST['password']) && !preg_match($pwdpattern, $_POST['password'])) {
        $error['password'] = "Mot de passe trop faible";
    }

    if (empty($error)) {
        $token = str_random(60);
        $user = $_POST['name'];
        $email = $_POST['email'];
        $password = password_hash($_POST['password'], PASSWORD_BCRYPT);
        // mysqli_insert_id($link)
        $query = ("INSERT INTO users VALUES (null, '$user', '$email', '$password')");

        if (mysqli_query($connexion, $query)) {

        	// echo $user . "enregistré avec succès";
            // mysqli_insert_id($connexion) : recupère l'id de la dernière insertion
            $user_id = mysqli_insert_id($connexion);

            mail($_POST['email'], "Confirmation de votre compte", "Veuillez cliquer sur ce lien pour valider votre compte\n\nconfirm.php?id={$user_id}&token={$token}");
            $_SESSION['flash']['success'] = "Confirmez l'email reçu";
            header("Location: login.php");
            exit();
        } else {
            echo "Error: " . $query . "" . mysqli_error($connexion);
        }

        mysqli_close($connexion);
    }
    // else{
    //     $pwd = $_POST['password'];

    //     $query = "SELECT id FROM users WHERE password = $pwd";

    //     $result = mysqli_query($connexion, $query);

    //     $data = mysqli_fetch_row($result);

    //     if ($data[0]) {
    //         echo "C"..
    //     }
    // }
}



?>


<?php require 'header.php'; ?>



<!-- <div class="conteneur">
    <div class="conteneurLogo">
        <div class="cercle">
            <p>S'inscrire</p>
        </div>

    </div>
        

    <div class="conteneurInput">
        <form action="" method="POST">
            <input type="text" required maxlength="15" placeholder="Pseudo" name="name">
            <input type="email" required placeholder="Email" name="email" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$">
            <input type="password" required maxlength="30" placeholder="Mot de passe" pattern="^[0-9a-zA-Z]{8,}$"
                name="password">

            <button class="btn" type="submit">S'inscrire</button>
        </form>

        <p class="textFin">
            Avez-vous déjà un compte? <a href="login.php">Se connecter </a>
        </p>
    </div>
</div>
 -->

<?php require 'footer.php'; ?>